
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../automate/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Developer Notes - S.O. Conda</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#developer-notes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="S.O. Conda" class="md-header__button md-logo" aria-label="S.O. Conda" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            S.O. Conda
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Developer Notes
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="S.O. Conda" class="md-nav__button md-logo" aria-label="S.O. Conda" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    S.O. Conda
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Use and Customization
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../automate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Automated Deployment
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Developer Notes
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Developer Notes
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#releases" class="md-nav__link">
    <span class="md-ellipsis">
      Releases
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changing-the-build-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Changing the Build Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Changing the Build Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Package Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-install-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Post-install Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-bundled-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      Updating Bundled Recipes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-new-package-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      Adding New Package Recipes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/simonsobs/soconda" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Source on GitHub
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#releases" class="md-nav__link">
    <span class="md-ellipsis">
      Releases
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changing-the-build-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Changing the Build Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Changing the Build Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#package-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Package Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-install-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Post-install Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-bundled-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      Updating Bundled Recipes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-new-package-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      Adding New Package Recipes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="developer-notes">Developer Notes</h1>
<p>This section covers steps needed when maintaining the <code>soconda</code> tools.</p>
<h2 id="releases">Releases</h2>
<p>After updating the versions of included packages, it is a good idea to make a
new release so that a new environment is built and deployed. After all
outstanding changes are merged to <code>main</code>, go to the github page for this
repository and click on the <code>Actions</code> tab. Trigger the <code>Test Build</code> workflow.
This will take an hour or so to run. Assuming it all works, create a new
release with some notes about what was updated. Cron jobs running on our
computing centers will check for new tags and build them if found.</p>
<h2 id="changing-the-build-configuration">Changing the Build Configuration</h2>
<p>The <code>config/common.txt</code> file contains conda packages that should be installed on all
systems. There are subdirectories under <code>config</code> for each unique machine / build
configuration. Here we discuss the contents of each of these subdirectories.</p>
<h3 id="environment-setup">Environment Setup</h3>
<p>There are two optional files which can be used to control how the environment is set up.
After installation, an optional soconda modulefile is installed. You can add custom
initialization lines to this module file by placing them in a file named:</p>
<pre><code>config/&lt;name_of_config&gt;/module_init
</code></pre>
<p>The lines in this file should be compatible with whatever module flavor is used on the
system. For example, if the system is using lmod, then this snippet should be lua
commands. If the system is using TCL based modules, then this snippet should be tcl
commands.</p>
<p>When building / installing soconda, you can place arbitrary shell commands in a file
named:</p>
<pre><code>config/&lt;name_of_config&gt;/build_env.sh
</code></pre>
<p>This file will be sourced by the <code>soconda.sh</code> script before starting. Note that these
commands are only executed during the installation. For run time setup, put module
commands in the <code>module_init</code> file.</p>
<h3 id="package-selection">Package Selection</h3>
<p>There are 3 files that control which packages are installed for a particular
configuration (in addition to the conda-forge packages listed in <code>config/common.txt</code>).
To specify packages (including the python version) to be installed from conda-forge, add
those to:</p>
<pre><code>config/&lt;name_of_config&gt;/packages_conda.txt
</code></pre>
<p>To control which conda packages should be built from the local recipes, add packages to:</p>
<pre><code>config/&lt;name_of_config&gt;/packages_local.txt
</code></pre>
<p>And finally, to install packages with pip, add them to the file:</p>
<pre><code>config/&lt;name_of_config&gt;/packages_pip.txt
</code></pre>
<p>Note that each of these pip packages is analyzed with <code>pipgrip</code> to find their
dependencies and those dependencies are installed with conda if available. This reduces
the number PyPI packages that end up in the final environment.</p>
<h3 id="post-install-steps">Post-install Steps</h3>
<p>An optional shell snippet can be specified at:</p>
<pre><code>config/&lt;name_of_config&gt;/post_install.sh
</code></pre>
<p>And this file will be sourced in soconda.sh after the installation is complete, and
while the installed environment is active. This file can contain arbitrary shell
commands to do things like change permissions, override a package, etc. There are also 2
shell variables that can be modified in this file which control behavior at the end of
soconda.sh:</p>
<pre><code>install_module=yes
install_jupyter_setup=yes
</code></pre>
<p>The first option controls whether to install the soconda modulefile. Enabling the second
option will install a script that allows users to create a jupyter kernel file for the
soconda stack.</p>
<h2 id="updating-bundled-recipes">Updating Bundled Recipes</h2>
<p>The conda recipes for bundled packages should be updated whenever upstream
packages have new releases. This involves the following steps:</p>
<ol>
<li>
<p>Update the version in the <code>meta.yaml</code> file of the package recipe.</p>
</li>
<li>
<p>Update the download URL if needed.</p>
</li>
<li>
<p>Compute the new sha256:</p>
<p>curl -sL https://github.com/username/reponame/archive/vX.X.X.tar.gz | openssl sha256</p>
</li>
<li>
<p>Copy the hash into the <code>meta.yaml</code> file.</p>
</li>
<li>
<p>Ensure that the new version of the package does not have any updated
dependencies or other constraints.</p>
</li>
</ol>
<h2 id="adding-new-package-recipes">Adding New Package Recipes</h2>
<p>This should not be needed very often, and will require some familiarity with
conda recipes. Create a new directory for the recipe in the <code>pkgs</code> directory.
Add a <code>meta.yaml</code> file, a <code>build.sh</code> file, and a copy of the package license.
See the conda documentation and existing conda-forge feedstocks for extensive
examples. You can load an existing soconda environment as a testbed and then
test your new recipe with <code>conda build</code>. After you can build it independently,
add it to the <code>packages_local.txt</code> file.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "navigation.path"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>